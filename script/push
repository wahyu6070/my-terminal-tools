#!/data/data/com.termux/files/usr/bin/bash

# ==========================================================
# WAHYU KURNIAWAN - SMART UPDATE DATE (ANALOGI MENU 9)
# ==========================================================

# --- KONFIGURASI WARNA (Sesuai Python Mas Wahyu) ---
W='\033[0m'  # White
R='\033[31m' # Red
G='\033[32m' # Green
C='\033[36m' # Cyan
Y='\033[33m' # Yellow

# --- KONFIGURASI TARGET ---
TARGET_DIR="./content/game"
TIME_LIMIT_SEC=86400 # 2 Jam (Analogi: TIME_LIMIT di Python)

# --- 1. VALIDASI FOLDER ---
if [ ! -d "$TARGET_DIR" ]; then
    echo -e "${R}[Error] Folder $TARGET_DIR tidak ditemukan.${W}"
    exit 1
fi

echo -e "${Y}[+] Memulai Smart Update 'date' (Recent Files Only)${W}"
echo -e "${C}Target: $TARGET_DIR (.md saja)${W}"

count_updated=0
count_skipped=0

# --- 2. SCANNING (Analogi: os.walk & (now - mtime) > TIME_LIMIT) ---
# find akan mencari semua file .md dalam folder game
while IFS= read -r -d '' file; do
    
    # Ambil mtime file (Analogi: mtime = os.path.getmtime)
    mtime=$(stat -c %Y "$file")
    now=$(date +%s)
    
    # Cek batas waktu (Analogi: if (now - mtime) > TIME_LIMIT)
    if [ $((now - mtime)) -gt $TIME_LIMIT_SEC ]; then
        ((count_skipped++))
        continue
    fi

    # Format tanggal baru (Analogi: new_date_str = dt.strftime)
    new_date_str=$(date -r "$file" "+%Y-%m-%dT%H:%M:%S+07:00")

    # 3. IDENTIFIKASI BARIS (Analogi: REGEX_DATE.search)
    # Mencari baris yang dimulai dengan 'date', menangkap separator (: atau =)
    line_data=$(grep -E "^date[[:space:]]*[:=]" "$file" | head -n 1)

    if [ -n "$line_data" ]; then
        # Ekstrak separator (Analogi: separator = match.group(1))
        if [[ "$line_data" == *":"* ]]; then
            sep=":"
        else
            sep="="
        fi

        # Ekstrak nilai lama (Analogi: old_date_str = match.group(2))
        old_val_raw=$(echo "$line_data" | cut -d"$sep" -f2- | xargs)

        # 4. PERBANDINGAN KARAKTER (Analogi: if new_date_str[:16] != old_date_str[:16])
        if [ "${new_date_str:0:16}" != "${old_val_raw:0:16}" ]; then
            
            # 5. REPLACE (Analogi: REGEX_DATE.sub)
            # Mengganti baris pertama yang cocok dengan format yang sama
            sed -i "0,/^date[[:space:]]*[:=].*/s//date ${sep} ${new_date_str}/" "$file"

            echo -e "${G}âœ” FRESH UPDATE: ${file#$TARGET_DIR/}${W}"
            echo -e "   ${R}${old_val_raw}${W} -> ${G}${new_date_str}${W}"
            ((count_updated++))
        else
            ((count_skipped++))
        fi
    fi

done < <(find "$TARGET_DIR" -type f -name "*.md" -print0)

# --- 6. SUMMARY ---
echo -e "\n=================================================="
if [ $count_updated -eq 0 ]; then
    echo -e "${Y}Tidak ada file yang diedit dalam 2 jam terakhir.${W}"
    echo -e "${C}(Skipped $count_skipped file lama/sudah sinkron)${W}"
else
    echo -e "${G}Sukses! $count_updated file berhasil diperbarui tanggalnya.${W}"
fi
echo -e "=================================================="

# --- 7. AUTO PUSH (Optional) ---
if [ $count_updated -gt 0 ]; then
    git add .
    git commit -m "Update content & date: $(date '+%Y-%m-%d %H:%M')"
    git push
fi
