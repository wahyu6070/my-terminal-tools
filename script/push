#!/bin/bash

# ==========================================================
# WAHYU KURNIAWAN - SMART UPDATE DATE (GLOBAL TOOL)
# Fungsi: Update frontmatter 'date' hanya untuk file yang
#         diedit dalam 1 jam terakhir.
# Versi : Native Bash untuk Termux (Global Bin)
# ==========================================================

# --- KONFIGURASI WARNA ---
GREEN='\033[0;32m'
RED='\033[0;31m'
CYAN='\033[0;36m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# --- DETEKSI DIREKTORI SAAT INI ---
# Script akan bekerja pada folder tempat perintah dijalankan
CURRENT_DIR=$(pwd)
TARGET_DIR="$CURRENT_DIR/content"
TIME_LIMIT_MIN=60 # 1 Jam

# --- VALIDASI FOLDER HUGO ---
if [ ! -d "$TARGET_DIR" ]; then
    echo -e "${RED}[Error] Folder 'content' tidak ditemukan di sini.${NC}"
    echo -e "${YELLOW}Pastikan Anda berada di root folder proyek Hugo Anda.${NC}"
    echo -e "Lokasi saat ini: $CURRENT_DIR"
    exit 1
fi

git pull

echo -e "${CYAN}--- Memindai File Baru (Diedit 1 Jam Terakhir) ---${NC}"
echo -e "Target: $TARGET_DIR"

# Inisialisasi Counter
count_updated=0
count_processed=0

# Loop menggunakan find untuk mencari file .md/.html yang dimodifikasi < 60 menit
while IFS= read -r -d '' file; do
    ((count_processed++))

    # 1. Ambil Waktu Modifikasi File (mtime)
    # Format: YYYY-MM-DDTHH:MM:SS+07:00 (WIB)
    NEW_DATE_STR=$(date -r "$file" "+%Y-%m-%dT%H:%M:%S+07:00")

    # 2. Cek apakah file memiliki baris 'date' di frontmatter
    # Regex: Mencari baris yang diawali 'date', diikuti spasi, lalu : atau =
    OLD_LINE=$(grep -E "^date[[:space:]]*[:=]" "$file" | head -n 1)

    if [ -n "$OLD_LINE" ]; then
        # 3. Bersihkan string lama untuk perbandingan
        OLD_VAL_CLEAN=$(echo "$OLD_LINE" | sed -E 's/^date[[:space:]]*[:=][[:space:]]*//' | tr -d '"' | tr -d "'")
        
        # Ambil substring 16 karakter pertama (YYYY-MM-DDTHH:MM)
        SUB_NEW=${NEW_DATE_STR:0:16}
        SUB_OLD=${OLD_VAL_CLEAN:0:16}

        # 4. Bandingkan (Hanya update jika menit berbeda)
        if [ "$SUB_NEW" != "$SUB_OLD" ]; then
            # Lakukan Penggantian in-place dengan SED
            # Menjaga separator asli (: atau =)
            sed -i -E "s/^(date[[:space:]]*[:=][[:space:]]*).*/\1$NEW_DATE_STR/" "$file"

            # Tampilkan path relatif agar rapi
            REL_PATH=${file#"$CURRENT_DIR/"}
            
            echo -e "${GREEN}âœ” FRESH UPDATE: $REL_PATH${NC}"
            echo -e "   ${RED}Lama: $OLD_VAL_CLEAN${NC}"
            echo -e "   ${GREEN}Baru: $NEW_DATE_STR${NC}"
            
            ((count_updated++))
        fi
    fi

done < <(find "$TARGET_DIR" -type f \( -name "*.md" -o -name "*.html" \) -mmin -"$TIME_LIMIT_MIN" -print0)

echo -e "=================================================="
if [ $count_updated -eq 0 ]; then
    echo -e "${YELLOW}Tidak ada file yang perlu diupdate (1 jam terakhir).${NC}"
else
    echo -e "${GREEN}Sukses! $count_updated file berhasil diperbarui tanggalnya.${NC}"
fi

hugo --noBuildLock
p
