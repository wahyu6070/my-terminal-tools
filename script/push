#!/data/data/com.termux/files/usr/bin/bash

# ==============================================================================
# SCRIPT: SMART UPDATE DATE & AUTO PUSH (v2.0)
# AUTHOR: Wahyu Kurniawan
# DESCRIPTION: 
#   Secara otomatis memindai file Markdown (.md) di dalam folder target,
#   mencari file yang baru saja dimodifikasi (dalam waktu yang ditentukan),
#   lalu memperbarui parameter 'date:' di Front Matter agar sesuai dengan
#   waktu modifikasi file tersebut. Setelah itu, melakukan Git Push.
# ==============================================================================

# --- 1. KONFIGURASI WARNA TERMINAL ---
W='\033[0m'       # Reset
R='\033[1;31m'    # Merah Terang
G='\033[1;32m'    # Hijau Terang
C='\033[1;36m'    # Cyan Terang
Y='\033[1;33m'    # Kuning Terang
M='\033[1;35m'    # Magenta Terang
B='\033[1;34m'    # Biru Terang

# --- 2. KONFIGURASI SISTEM ---
TARGET_DIR="./content/game"

# 7200 detik = 2 Jam (Sebelumnya 86400 / 24 jam)
TIME_LIMIT_SEC=7200 

# Menghitung jam secara dinamis untuk tampilan log
JAM_LIMIT=$((TIME_LIMIT_SEC / 3600))

echo -e "${C}======================================================${W}"
echo -e "${M}   S M A R T   U P D A T E   D A T E   &   P U S H    ${W}"
echo -e "${C}======================================================${W}"
echo -e "${Y}[*] Memulai pemindaian file Markdown...${W}"
echo -e "${C} -> Target Folder: ${W}${TARGET_DIR}"
echo -e "${C} -> Batas Waktu  : ${W}${JAM_LIMIT} Jam Terakhir (${TIME_LIMIT_SEC} Detik)\n"

# --- 3. VALIDASI AWAL SISTEM ---
# Cek eksistensi direktori target
if [ ! -d "$TARGET_DIR" ]; then
    echo -e "${R}[ERROR] Folder $TARGET_DIR tidak ditemukan!${W}"
    echo -e "${Y}Pastikan Anda menjalankan perintah ini di root direktori Hugo Anda.${W}"
    exit 1
fi

# Cek apakah ini adalah root repository git
if [ ! -d ".git" ]; then
    echo -e "${R}[ERROR] Direktori ini bukan repository Git! (.git tidak ditemukan)${W}"
    echo -e "${Y}Harap jalankan perintah di dalam repository website Anda.${W}"
    exit 1
fi

count_updated=0
count_skipped=0
count_error=0

# --- 4. PROSES PEMINDAIAN FILE (FIND LOOP) ---
echo -e "${B}[*] Memindai struktur folder dan menghitung timestamp...${W}"

# find akan mencari semua file .md dalam folder game dengan aman
while IFS= read -r -d '' file; do
    
    # Ekstrak waktu modifikasi file dalam format Unix Epoch (Detik)
    mtime=$(stat -c %Y "$file")
    now=$(date +%s)
    selisih=$((now - mtime))
    
    # Lewati file jika usianya lebih tua dari TIME_LIMIT_SEC
    if [ $selisih -gt $TIME_LIMIT_SEC ]; then
        ((count_skipped++))
        continue
    fi

    # Format tanggal baru sesuai standar Hugo/Markdown (ISO 8601 dengan Timezone WIB)
    # Contoh format: 2026-02-23T15:30:00+07:00
    new_date_str=$(date -r "$file" "+%Y-%m-%dT%H:%M:%S+07:00")

    # Mengambil baris pertama yang mendefinisikan 'date' di Front Matter
    line_data=$(grep -E "^date[[:space:]]*[:=]" "$file" | head -n 1)

    if [ -n "$line_data" ]; then
        # Deteksi pemisah (apakah menggunakan titik dua ':' atau sama dengan '=')
        if [[ "$line_data" == *":"* ]]; then
            sep=":"
        else
            sep="="
        fi

        # Ekstrak nilai tanggal yang lama dengan memotong string
        old_val_raw=$(echo "$line_data" | cut -d"$sep" -f2- | xargs)

        # Bandingkan 16 karakter pertama (YYYY-MM-DDTHH:MM)
        # Jika string berbeda, berarti file perlu di-update
        if [ "${new_date_str:0:16}" != "${old_val_raw:0:16}" ]; then
            
            # Gunakan GNU sed untuk mereplace kemunculan PERTAMA dari string date
            # Pola 0,/.../ memastikan hanya Front Matter yang diubah, bukan isi konten utama
            sed -i "0,/^date[[:space:]]*[:=].*/s//date ${sep} ${new_date_str}/" "$file"

            # Verifikasi apakah proses sed berjalan lancar tanpa interupsi
            if [ $? -eq 0 ]; then
                echo -e "${G}✔ UPDATED : ${W}${file#$TARGET_DIR/}"
                echo -e "   ${R}Lama : ${old_val_raw}${W}"
                echo -e "   ${G}Baru : ${new_date_str}${W}"
                ((count_updated++))
            else
                echo -e "${R}✘ GAGAL   : ${W}${file#$TARGET_DIR/} (Write Error)${W}"
                ((count_error++))
            fi
        else
            # Waktu sama, tidak perlu melakukan replace string
            ((count_skipped++))
        fi
    fi

# Membatasi pencarian hanya pada ekstensi .md
done < <(find "$TARGET_DIR" -type f -name "*.md" -print0)

# --- 5. RINGKASAN PEMINDAIAN ---
echo -e "\n${C}======================================================${W}"
echo -e "${M}   R I N G K A S A N   E K S E K U S I                ${W}"
echo -e "${C}======================================================${W}"

if [ $count_updated -eq 0 ]; then
    echo -e "${Y}[INFO] Tidak ada file Markdown yang perlu diperbarui tanggalnya.${W}"
    echo -e "${C} -> Detail: $count_skipped file dilewati (Di luar batas waktu atau sudah sinkron).${W}"
    
    # Tampilkan jika terjadi error permission
    if [ $count_error -gt 0 ]; then
        echo -e "${R} -> PERINGATAN: Terdapat $count_error file gagal ditulis!${W}"
    fi
else
    echo -e "${G}[SUKSES] Berhasil memperbarui $count_updated file!${W}"
    echo -e "${C} -> Detail: $count_skipped file dilewati tanpa diubah.${W}"
fi
echo -e "${C}======================================================${W}\n"

# --- 6. AUTOMASI GIT PUSH (DENGAN SMART DETECTION) ---
# Memeriksa apakah ada perubahan apapun pada repository (termasuk file lain)
if [ -n "$(git status --porcelain)" ]; then
    echo -e "${Y}[*] Mendeteksi perubahan direktori, mengeksekusi Git Push...${W}"
    
    echo -e "${B} -> Menjalankan command 'git add .'${W}"
    git add .
    
    COMMIT_MSG="Auto-update content & timestamp: $(date '+%Y-%m-%d %H:%M:%S WIB')"
    echo -e "${B} -> Menjalankan command 'git commit'${W}"
    echo -e "${C}    Pesan Commit: \"$COMMIT_MSG\"${W}"
    git commit -m "$COMMIT_MSG"
    
    echo -e "${B} -> Menjalankan command 'git push' ke remote server...${W}"
    git push
    
    if [ $? -eq 0 ]; then
        echo -e "\n${G}✔ PROSES SINKRONISASI PUSH SELESAI DENGAN SUKSES!${W}"
    else
        echo -e "\n${R}✘ GAGAL MELAKUKAN GIT PUSH!${W}"
        echo -e "${Y}Mohon periksa status koneksi jaringan atau konfigurasi SSH GitHub Anda.${W}"
    fi
else
    # Mencegah git error akibat mencoba nge-push repo yang tidak ada perubahannya
    echo -e "${G}[INFO] Tidak ada perubahan pada file (working tree clean). Proses Push dilewati.${W}"
fi
