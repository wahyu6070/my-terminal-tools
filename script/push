#!/data/data/com.termux/files/usr/bin/bash

# ==========================================================
# WAHYU KURNIAWAN - HUGO PUSHER (Game Folder Only)
# ==========================================================

set -e

# --- KONFIGURASI WARNA ---
GREEN='\033[0;32m'
RED='\033[0;31m'
CYAN='\033[0;36m'
YELLOW='\033[1;33m'
NC='\033[0m' 

# --- 1. VALIDASI LOKASI ---
CURRENT_DIR=$(pwd)
# Target spesifik ke folder game
TARGET_DIR="$CURRENT_DIR/content/game"
TIME_LIMIT_MIN=120 

if [ ! -d "$TARGET_DIR" ]; then
    echo -e "${RED}[Error] Folder '/content/game' tidak ditemukan.${NC}"
    echo -e "${YELLOW}Pastikan Anda berada di root project Hugo.${NC}"
    exit 1
fi

# --- 2. GIT PULL ---
echo -e "${CYAN}[1/4] Mengambil update dari GitHub...${NC}"
git pull

# --- 3. SMART DATE UPDATE (.md Only) ---
echo -e "${CYAN}[2/4] Memindai file .md di /content/game (2 jam terakhir)...${NC}"

count_updated=0
# Mencari hanya file .md dalam folder game
while IFS= read -r -d '' file; do
    
    # Ambil waktu modifikasi file
    NEW_DATE_STR=$(date -r "$file" "+%Y-%m-%dT%H:%M:%S+07:00")
    
    # Cek baris date di frontmatter
    if grep -qE "^date[[:space:]]*[:=]" "$file"; then
        OLD_LINE=$(grep -E "^date[[:space:]]*[:=]" "$file" | head -n 1)
        
        # Bandingkan jika berbeda
        if [[ "$OLD_LINE" != *"$NEW_DATE_STR"* ]]; then
            sed -i -E "s/^(date[[:space:]]*[:=][[:space:]]*).*/\1$NEW_DATE_STR/" "$file"
            
            REL_PATH=${file#"$CURRENT_DIR/"}
            echo -e "${GREEN}✔ UPDATED: $REL_PATH${NC}"
            ((count_updated++))
        fi
    fi
done < <(find "$TARGET_DIR" -type f -name "*.md" -mmin -"$TIME_LIMIT_MIN" -print0)

if [ $count_updated -eq 0 ]; then
    echo -e "${YELLOW}   -> Tidak ada file .md yang perlu diupdate tanggalnya.${NC}"
else
    echo -e "${GREEN}   -> $count_updated file berhasil diperbarui.${NC}"
fi

# --- 4. HUGO BUILD CHECK ---
echo -e "${CYAN}[3/4] Mengecek build Hugo...${NC}"
if hugo --noBuildLock --gc --minify --quiet; then
    echo -e "${GREEN}✔ Hugo Build: AMAN.${NC}"
else
    echo -e "${RED}✘ Hugo Build: GAGAL! Periksa kembali file .md Anda.${NC}"
    exit 1
fi

# --- 5. GIT PUSH ---
echo -e "${CYAN}[4/4] Mengirim update ke GitHub...${NC}"
git add .

# Cek apakah ada perubahan sebelum commit
if git diff --cached --quiet; then
    echo -e "${YELLOW}Tidak ada perubahan yang perlu dipush.${NC}"
else
    PESAN="${1:-Update content/game dan tanggal}"
    git commit -m "$PESAN"
    git push
    echo -e "${GREEN}=========================================${NC}"
    echo -e "${GREEN}   SELESAI! Web Anda sudah diperbarui.   ${NC}"
    echo -e "${GREEN}=========================================${NC}"
fi
