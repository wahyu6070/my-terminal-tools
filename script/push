#!/data/data/com.termux/files/usr/bin/bash

# ==========================================================
# WAHYU KURNIAWAN - HUGO DATE UPDATER (Python Logic Port)
# Target: /content/game | Mode: Recent Only (120 Min)
# ==========================================================

set -e

# --- KONFIGURASI WARNA ---
G='\033[32m' # Hijau
R='\033[31m' # Merah
C='\033[36m' # Cyan
Y='\033[33m' # Kuning
W='\033[0m'  # Reset

# --- KONFIGURASI TARGET ---
TARGET_DIR="./content/game"
TIME_LIMIT_MIN=120 # Analogi: 2 Jam (7200 detik)

if [ ! -d "$TARGET_DIR" ]; then
    echo -e "${R}[Error] Folder $TARGET_DIR tidak ditemukan!${W}"
    exit 1
fi

echo -e "${C}[+] Memulai Smart Update 'date' (Analogi Menu 9)${W}"
echo -e "${C}ðŸŽ¯ Target: $TARGET_DIR (.md saja)${W}"

count_updated=0
count_skipped=0

# --- PROSES PEMINDAIAN ---
# find mencari file .md yang dimodifikasi dalam 120 menit terakhir
while IFS= read -r -d '' file; do
    
    # 1. Ambil waktu modifikasi file (mtime)
    # Format: YYYY-MM-DDTHH:MM:SS+07:00
    NEW_DATE_STR=$(date -r "$file" "+%Y-%m-%dT%H:%M:%S+07:00")
    
    # 2. Cek apakah ada baris 'date' (Mendukung ':' atau '=')
    # Analogi Python: REGEX_DATE = re.compile(r'^date\s*([:=])\s*(.*)$')
    if grep -qE "^date[[:space:]]*[:=]" "$file"; then
        
        # Ambil nilai tanggal lama yang ada di file
        OLD_LINE=$(grep -E "^date[[:space:]]*[:=]" "$file" | head -n 1)
        
        # 3. Bandingkan (Hanya update jika 16 karakter pertama berbeda - YYYY-MM-DDTHH:MM)
        # Ini mencegah penulisan ulang jika hanya detik yang berubah
        if [[ "$OLD_LINE" != *"${NEW_DATE_STR:0:16}"* ]]; then
            
            # Eksekusi Update menggunakan sed (in-place)
            # Menjaga separator asli (: atau =)
            sed -i -E "s/^(date[[:space:]]*[:=][[:space:]]*).*/\1$NEW_DATE_STR/" "$file"
            
            echo -e "${G}âœ” FRESH UPDATE: ${file#$TARGET_DIR/}${W}"
            echo -e "   ${R}${OLD_LINE#*[:=]}${W} -> ${G}$NEW_DATE_STR${W}"
            ((count_updated++))
        else
            ((count_skipped++))
        fi
    fi

done < <(find "$TARGET_DIR" -type f -name "*.md" -mmin -"$TIME_LIMIT_MIN" -print0)

# --- RINGKASAN AKHIR ---
echo -e "\n--------------------------------------------------"
if [ $count_updated -eq 0 ]; then
    echo -e "${Y}Tidak ada file yang perlu diperbarui tanggalnya.${W}"
else
    echo -e "${G}Sukses! $count_updated file berhasil sinkron dengan mtime.${W}"
fi
echo -e "${C}(Skipped $count_skipped file yang sudah sinkron)${W}"
echo -e "--------------------------------------------------"

# --- LANJUT KE HUGO & GIT ---
if [ $count_updated -gt 0 ]; then
    echo -e "${C}[+] Menjalankan integrasi Hugo...${W}"
    hugo --noBuildLock --gc --minify --quiet
    
    git add .
    git commit -m "Update game content & dates: $(date '+%Y-%m-%d %H:%M')"
    git push
    echo -e "${G}âœ… SEMUA SELESAI & LIVE!${W}"
fi
