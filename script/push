#!/bin/bash

#!/data/data/com.termux/files/usr/bin/bash

# ==========================================================
# WAHYU KURNIAWAN - ALL IN ONE HUGO PUSHER
# Fungsi: Update Date > Cek Build Hugo > Git Push
# ==========================================================

# Hentikan script jika ada error (Safety First)
set -e

# --- KONFIGURASI WARNA ---
GREEN='\033[0;32m'
RED='\033[0;31m'
CYAN='\033[0;36m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# --- 1. VALIDASI LOKASI ---
CURRENT_DIR=$(pwd)
TARGET_DIR="$CURRENT_DIR/content"
TIME_LIMIT_MIN=60 # 1 Jam

if [ ! -d "$TARGET_DIR" ]; then
    echo -e "${RED}[Error] Folder 'content' tidak ditemukan.${NC}"
    echo -e "${YELLOW}Jalankan script ini di root folder Hugo Anda.${NC}"
    exit 1
fi

# --- 2. GIT PULL (Cek Update Dulu) ---
echo -e "${CYAN}[1/4] Mengambil update dari remote (Git Pull)...${NC}"
git pull

# --- 3. SMART DATE UPDATE ---
echo -e "${CYAN}[2/4] Memindai file yang diedit 1 jam terakhir...${NC}"

count_updated=0
count_processed=0

# Mencari file .md/.html yang dimodifikasi < 60 menit
while IFS= read -r -d '' file; do
    ((count_processed++))

    # Format Waktu: YYYY-MM-DDTHH:MM:SS+07:00 (WIB)
    NEW_DATE_STR=$(date -r "$file" "+%Y-%m-%dT%H:%M:%S+07:00")

    # Cek frontmatter 'date'
    OLD_LINE=$(grep -E "^date[[:space:]]*[:=]" "$file" | head -n 1)

    if [ -n "$OLD_LINE" ]; then
        # Bersihkan string lama
        OLD_VAL_CLEAN=$(echo "$OLD_LINE" | sed -E 's/^date[[:space:]]*[:=][[:space:]]*//' | tr -d '"' | tr -d "'")
        
        # Bandingkan 16 karakter pertama (YYYY-MM-DDTHH:MM)
        SUB_NEW=${NEW_DATE_STR:0:16}
        SUB_OLD=${OLD_VAL_CLEAN:0:16}

        if [ "$SUB_NEW" != "$SUB_OLD" ]; then
            # Ganti tanggal (in-place)
            sed -i -E "s/^(date[[:space:]]*[:=][[:space:]]*).*/\1$NEW_DATE_STR/" "$file"

            REL_PATH=${file#"$CURRENT_DIR/"}
            echo -e "${GREEN}✔ UPDATED: $REL_PATH${NC}"
            ((count_updated++))
        fi
    fi
done < <(find "$TARGET_DIR" -type f \( -name "*.md" -o -name "*.html" \) -mmin -"$TIME_LIMIT_MIN" -print0)

if [ $count_updated -eq 0 ]; then
    echo -e "${YELLOW}   -> Tidak ada tanggal yang perlu diupdate.${NC}"
else
    echo -e "${GREEN}   -> $count_updated file diperbarui.${NC}"
fi

# --- 4. HUGO BUILD CHECK ---
echo -e "${CYAN}[3/4] Mengecek integritas kode Hugo...${NC}"
# Jika hugo gagal, script akan berhenti di sini karena 'set -e'
if hugo --noBuildLock --gc --minify --quiet; then
    echo -e "${GREEN}✔ Hugo Build: AMAN (Tidak ada error).${NC}"
else
    echo -e "${RED}✘ Hugo Build: GAGAL! Perbaiki error sebelum push.${NC}"
    exit 1
fi

# --- 5. GIT PUSH ---
echo -e "${CYAN}[4/4] Mengirim ke GitHub...${NC}"
git add .

# Pesan commit (default: "Update content & date")
PESAN="${1:-Update content & date}"
git commit -m "$PESAN"

git push

echo -e "${GREEN}=========================================${NC}"
echo -e "${GREEN}   SELESAI! Website Anda sudah live.     ${NC}"
echo -e "${GREEN}=========================================${NC}"
